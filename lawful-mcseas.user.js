// ==UserScript==
// @name         lawful-mcseas
// @name:en      Lawful MC seas
// @name:zh-CN   秩序心海
// @namespace    https://mcseas.club/home.php?mod=space&uid=95082
// @version      0.3.2-alpha
// @author       Miyoi
// @description  改善「混沌心海」论坛的使用体验。
// @license      MIT
// @icon         https://mcseas.club/favicon.ico
// @homepage     https://mcseas.club/forum.php?mod=viewthread&tid=50579
// @match        *://mcseas.club/*
// @require      https://unpkg.com/heti/umd/heti-addon.min.js
// @resource     css  https://unpkg.com/heti/umd/heti.min.css
// @grant        GM_addStyle
// @grant        GM_deleteValue
// @grant        GM_getResourceText
// @grant        GM_getValue
// @grant        GM_listValues
// @grant        GM_log
// @grant        GM_openInTab
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// ==/UserScript==

(function () {
	'use strict';

	var k=Object.defineProperty;var S=(e,t,n)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var a=(e,t,n)=>(S(e,typeof t!="symbol"?t+"":t,n),n);var c=(()=>typeof GM_addStyle<"u"?GM_addStyle:void 0)(),z=(()=>typeof GM_deleteValue<"u"?GM_deleteValue:void 0)(),x=(()=>typeof GM_getResourceText<"u"?GM_getResourceText:void 0)(),l=(()=>typeof GM_getValue<"u"?GM_getValue:void 0)(),w=(()=>typeof GM_listValues<"u"?GM_listValues:void 0)(),I=(()=>typeof GM_log<"u"?GM_log:void 0)(),V=(()=>typeof GM_openInTab<"u"?GM_openInTab:void 0)(),_=(()=>typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0)(),M=(()=>typeof GM_setValue<"u"?GM_setValue:void 0)(),$=(()=>typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0)(),C=(()=>window)();const T="lawful-mcseas",q="0.3.2",j="module",D={dev:"vite",build:"tsc && vite build",preview:"vite preview"},E={typescript:"^5.1.6","unplugin-auto-import":"^0.16.6",vite:"^4.4.8","vite-plugin-monkey":"^3.4.0"},H={name:T,private:!0,version:q,type:j,scripts:D,devDependencies:E};class U{current(){const t=new Date,n=(s,y=2,G="0")=>s.toString().padStart(y,G);return [n(t.getFullYear(),4),n(t.getMonth()),n(t.getDate())].join("-")+" "+[n(t.getHours()),n(t.getMinutes()),n(t.getSeconds())].join(":")}debug(...t){I(`${this.current()} | DEBUG |`,...t);}log(...t){console.log(`${this.current()} [秩序心海]`,...t);}}class A{constructor(){a(this,"version",`${H.version}-alpha`);a(this,"auto_format");a(this,"font_name");a(this,"font_size");a(this,"only_format_lz");a(this,"block_ip_warning");a(this,"block_email_warning");this.load();}load(){this.auto_format=l("cfg_auto_format")!=="false",this.font_name=l("cfg_font_name")||"小赖字体 等宽 SC",this.font_size=Number(l("cfg_font_size")),this.font_size=this.font_size>0?this.font_size:16,this.only_format_lz=l("cfg_only_format_lz")!=="false",this.block_ip_warning=l("cfg_block_ip_warning")==="true",this.block_email_warning=l("cfg_block_email_warning")==="true";}save(t,n){M(`cfg_${t}`,n),this.load();}}const i=new U,o=new A;i.debug("lawful-mcseas 脚本开发中...");i.debug("GM_listValues()",w());i.log("脚本当前版本:",o.version);i.log("自动格式化正文:",o.auto_format);i.log(`自动格式化时 正文字体: "${o.font_name}"`);i.log(`自动格式化时 正文字体大小: ${o.font_size} px`);i.log("只格式化一楼:",o.only_format_lz);i.log("自动屏蔽异地 IP 登录提醒:",o.block_ip_warning);let u=setInterval(()=>{setTimeout(L,0);},50),f=0;function L(){f+=1,f>50&&clearInterval(u);let e=document.querySelector("button#fwin_dialog_submit");e&&(e.click(),clearInterval(u));}let r={click_num:void 0,auto_format:void 0,format_font_name:void 0,format_font_size:void 0,switch_ip_warning:void 0,go_to_report:void 0,reset_config:void 0};const d=()=>{Object.values(r).forEach(e=>{e&&$(e);}),r.click_num=_("👆 点击了 "+l("click_num",0)+" 次",()=>{M("click_num",l("click_num",0)+1),d();}),r.auto_format=_((o.auto_format?"✔️ 已启用":"❌ 已禁用")+"自动格式化正文",()=>{o.save("auto_format",o.auto_format?"false":"true"),i.log((o.auto_format?"✔️ 已启用":"❌ 已禁用")+"自动格式化正文"),window.location.reload();}),o.auto_format&&(r.format_font_name=_(`　├─ 🗚 字体: "${o.font_name}"`,()=>{const e=prompt("请输入自定义字体名称 (需要电脑里已经安装好的字体):",o.font_name);e?(o.save("font_name",e),i.log(`字体设置为: "${e}"`),window.location.reload()):i.debug("用户取消输入");}),r.format_font_size=_(`　└─ 🗚 字体大小: ${o.font_size} px`,()=>{const e=Number(prompt("请输入自定义字体大小, 单位为像素(px):",String(o.font_size)));e>0?(o.save("font_size",String(e)),i.log(`字体大小设置为: ${e} px`),window.location.reload()):i.debug("用户取消输入");})),r.switch_ip_warning=_((o.block_ip_warning?"❌ 已禁用":"✔️ 已启用")+"异地 IP 登录提醒",()=>{o.save("block_ip_warning",o.block_ip_warning?"false":"true"),i.log((o.block_ip_warning?"❌ 已禁用":"✔️ 已启用")+"异地 IP 登录提醒"),d();}),r.go_to_report=_("🆕 提出需求 & 反馈 BUG",()=>{V("https://mcseas.club/forum.php?mod=viewthread&tid=50579",!1);}),r.reset_config=_("🆑 重置所有配置项",()=>{w().forEach(e=>{z(e);}),window.location.reload();});};d();if(o.block_ip_warning){let e=function(){n+=1,n>50&&clearInterval(t);let s=document.querySelectorAll("#ip_notice .bm_h a");s.length===1&&(s[0].click(),clearInterval(t));},t=setInterval(()=>{setTimeout(e,0);},50),n=0;}const m=window.location.href.match(/[&#]pid=?(\d+)/i);var p;if(m!==null){const e=m[1];let t=document.querySelector(`#pid${e}`);t&&((p=t.querySelector("td.plc"))==null||p.classList.add("highlight-card"),c(".highlight-card { background-color: #dedbcc; color: #363636; -moz-box-shadow: 0.075rem 0.125rem 0.25rem rgba(0, 0, 0, 0.5); -webkit-box-shadow: 0.075rem 0.125rem 0.25rem rgba(0, 0, 0, 0.5); box-shadow: 0.075rem 0.125rem 0.25rem rgba(0, 0, 0, 0.5); } .highlight-card:hover { -webkit-box-shadow: 0 0.325rem 1.75rem rgba(0, 0, 0, 0.3); -moz-box-shadow: 0 0.325rem 1.75rem rgba(0, 0, 0, 0.3); box-shadow: 0 0.325rem 1.75rem rgba(0, 0, 0, 0.3); }"));}var v;(v=document.querySelector("#append_parent"))==null||v.classList.add("heti-parent");let g=document.querySelectorAll("div#pt > div.z > a");var b,h;if(g.length>4&&["原创文学","审核区"].includes(g[3].innerText)){let e=document.querySelectorAll("table.plhin td.plc");for(let t=0;t<e.length&&!(o.only_format_lz&&((b=e[t].querySelector("div.pi > strong > a"))==null?void 0:b.innerText.trim())!=="战列舰");t++)(h=e[t].querySelector(".t_f"))==null||h.classList.add("heti");}if(o.auto_format){const e=[c(x("css")),c(`.heti, .heti-parent .pcb { font-family: "${o.font_name}", "Helvetica Neue", helvetica, arial, "Heti Hei", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; font-size: ${o.font_size}px; }`)];i.debug("执行自动格式化 新增 CSS",e),window.onload=()=>{new C.Heti(".heti, .heti-parent .pcb").autoSpacing();};}

})();